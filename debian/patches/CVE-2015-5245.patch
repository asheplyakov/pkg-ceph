From ad5507fe0bf72ed5bdf8353e315cc9092c740144 Mon Sep 17 00:00:00 2001
From: Yehuda Sadeh <yehuda@redhat.com>
Date: Thu, 30 Jul 2015 14:47:15 -0700
Subject: [PATCH] rgw: url encode exposed bucket

Fixes: #12537
Don't send the bucket name back without url encoding it.

Signed-off-by: Yehuda Sadeh <yehuda@redhat.com>

The patch below is an adapted version for ceph 0.80.7 to only contain
the necessary changes to fix this vulnerability. Neither the quoting 
of the bucket name nor the missing \r are fixed.
(see http://tracker.ceph.com/issues/9254 and http://tracker.ceph.com/issues/11860)

---
 src/rgw/rgw_rest.cc | 7 +++++--
 1 file changed, 5 insertions(+), 2 deletions(-)

--- a/src/rgw/rgw_rest.cc
+++ b/src/rgw/rgw_rest.cc
@@ -272,8 +272,11 @@
 {
   int expose_bucket = g_conf->rgw_expose_bucket;
   if (expose_bucket) {
-    if (!s->bucket_name_str.empty())
-      s->cio->print("Bucket: \"%s\"\n", s->bucket_name_str.c_str());
+    if (!s->bucket_name_str.empty()) {
+      string b;
+      url_encode(s->bucket_name_str, b);
+      s->cio->print("Bucket: \"%s\"\n", b.c_str());
+    }
   }
 }
 
