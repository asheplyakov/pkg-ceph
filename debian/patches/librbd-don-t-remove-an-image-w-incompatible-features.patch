From: Dongsheng Yang <dongsheng.yang@easystack.cn>
Date: Thu, 22 Dec 2016 21:00:41 -0500
Subject: librbd: don't remove an image w/ incompatible features

Fixes: http://tracker.ceph.com/issues/18315
Signed-off-by: Dongsheng Yang <dongsheng.yang@easystack.cn>
(cherry picked from commit f76127b5e617923d14adb62bfb836a635c14f209)

X-tracker-ref: http://tracker.ceph.com/issues/18315
X-github-pr: https://github.com/ceph/ceph/pull/13156
X-short-title: Attempting to remove an image w/ incompatible features results in partial removal
---
 src/librbd/internal.cc | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/src/librbd/internal.cc b/src/librbd/internal.cc
index 073be35..4475c93 100644
--- a/src/librbd/internal.cc
+++ b/src/librbd/internal.cc
@@ -2105,6 +2105,9 @@ int mirror_image_disable_internal(ImageCtx *ictx, bool force,
     if (r < 0) {
       ldout(cct, 2) << "error opening image: " << cpp_strerror(-r) << dendl;
       delete ictx;
+      if (r != -ENOENT) {
+	return r;
+      }
     } else {
       string header_oid = ictx->header_oid;
       old_format = ictx->old_format;
