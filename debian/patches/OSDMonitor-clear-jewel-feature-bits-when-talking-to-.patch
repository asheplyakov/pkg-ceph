From: =?utf-8?q?Piotr_Da=C5=82ek?= <piotr.dalek@corp.ovh.com>
Date: Fri, 20 Jan 2017 16:07:10 +0100
Subject: OSDMonitor: clear jewel+ feature bits when talking to Hammer OSD
MIME-Version: 1.0
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: 8bit

During upgrade from Hammer to Jewel, when upgrading MONs first and OSDs
last, Jewel MONs send OSDMaps with components in encoding version not
encodable by Hammer OSDs, generating extra load on MONs due to requests
for full OSDMap after failing the CRC check.
Fix this by not including CEPH_FEATURE_NEW_OSDOP_ENCODING (which
is responsible for encoding pg_pool_t in version 24 instead of 21) and
CEPH_FEATURE_CRUSH_TUNABLES5 (responsible for adding chooseleaf_stable
field into encoded CRUSH map) when CEPH_OSDMAP_REQUIRE_JEWEL flag
is not present.

Fixes: http://tracker.ceph.com/issues/18582
Signed-off-by: Piotr Da≈Çek <piotr.dalek@corp.ovh.com>
(cherry picked from commit 496affc8d6b4595986eccda6305ecffdc7e7a550)
---
 src/mon/OSDMonitor.cc | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/src/mon/OSDMonitor.cc b/src/mon/OSDMonitor.cc
index b9cdc4d..658914e 100644
--- a/src/mon/OSDMonitor.cc
+++ b/src/mon/OSDMonitor.cc
@@ -1215,7 +1215,9 @@ void OSDMonitor::encode_pending(MonitorDBStore::TransactionRef t)
     // determine appropriate features
     if (!tmp.test_flag(CEPH_OSDMAP_REQUIRE_JEWEL)) {
       dout(10) << __func__ << " encoding without feature SERVER_JEWEL" << dendl;
-      features &= ~CEPH_FEATURE_SERVER_JEWEL;
+      features &= ~(CEPH_FEATURE_SERVER_JEWEL |
+	  CEPH_FEATURE_NEW_OSDOP_ENCODING |
+	  CEPH_FEATURE_CRUSH_TUNABLES5);
     }
     dout(10) << __func__ << " encoding full map with " << features << dendl;
 
